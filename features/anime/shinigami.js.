import axios from 'axios';

// --- FUNGSI SEARCH SHINIGAMI ---
async function shinigamiSearch(query) {
    try {
        // Kita gunakan API Ryzendesu yang sudah menghandle bypass Cloudflare Shinigami
        const { data } = await axios.get(`https://api.ryzendesu.com/api/search/shinigami?query=${encodeURIComponent(query)}`);

        if (data.action === 'success' && data.results && data.results.length > 0) {
            // Ambil hasil pertama (paling relevan)
            const firstResult = data.results[0];
            
            // Karena ini search result, kita rapikan datanya
            return {
                title: firstResult.title,
                status: firstResult.status || 'Ongoing',
                rating: firstResult.rating || '-',
                latest_chapter: firstResult.latestChapter || '-',
                cover: firstResult.thumb,
                link: firstResult.link
            };
        }
        return null;
    } catch (e) {
        console.error("Shinigami Error:", e.message);
        return null;
    }
}

// --- COMMAND HANDLER ---
export default {
    command: ['shinigami', 'manga'], // Command: .shinigami atau .manga
    execute: async (sock, m, { q, sender }) => {
        if (!q) return sock.sendMessage(sender, { text: 'âŒ Masukkan judul manga!\nContoh: .shinigami one piece' }, { quoted: m });

        await sock.sendMessage(sender, { text: 'â³ Sedang mencari komik...' }, { quoted: m });

        try {
            const result = await shinigamiSearch(q);

            if (!result) {
                return sock.sendMessage(sender, { text: 'âŒ Manga tidak ditemukan di Shinigami ID.' }, { quoted: m });
            }

            // Format Caption ala Shinigami
            let captionText = `ğŸ“š *SHINIGAMI ID*\n`;
            captionText += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            captionText += `ğŸ“– *Judul:* ${result.title}\n`;
            captionText += `â­ *Rating:* ${result.rating}\n`;
            captionText += `ğŸ“ *Status:* ${result.status}\n`;
            captionText += `ğŸ†• *Chapter:* ${result.latest_chapter}\n`;
            captionText += `ğŸ”— *Link:* ${result.link}\n`;
            captionText += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            captionText += `Created by FarisBot`;

            // Kirim Gambar Cover + Caption
            await sock.sendMessage(sender, { 
                image: { url: result.cover }, 
                caption: captionText 
            }, { quoted: m });

        } catch (error) {
            console.error("Handler Error:", error);
            sock.sendMessage(sender, { text: 'âŒ Terjadi kesalahan sistem.' }, { quoted: m });
        }
    }
};

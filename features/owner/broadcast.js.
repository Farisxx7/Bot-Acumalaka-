import { downloadContentFromMessage } from '@whiskeysockets/baileys';

// --- HELPER: Download Media ---
async function downloadMedia(msg, type) {
    const stream = await downloadContentFromMessage(msg, type);
    let buffer = Buffer.from([]);
    for await (const chunk of stream) {
        buffer = Buffer.concat([buffer, chunk]);
    }
    return buffer;
}

const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

export default {
    command: ['bc', 'broadcast', 'bcgroup'],
    execute: async (sock, m, { q, isOwner }) => {
        // 1. Cek Permission
        if (!isOwner) return sock.sendMessage(m.chat, { text: '‚ùå Fitur ini khusus Owner!' }, { quoted: m });

        // 2. Deteksi Media (Quote atau Kirim Langsung)
        const quoted = m.quoted ? m.quoted : m;
        const mime = (quoted.msg || quoted).mimetype || '';
        const isImage = /image/.test(mime);
        const isVideo = /video/.test(mime);
        
        // Text Broadcast
        const textToBroadcast = q || (quoted.text ? quoted.text : '');

        if (!textToBroadcast && !isImage && !isVideo) {
            return sock.sendMessage(m.chat, { text: '‚ùå Masukkan pesan atau reply gambar/video!' }, { quoted: m });
        }

        // 3. Ambil Daftar Grup (DENGAN SAFEGUARD)
        let groupIds = [];
        try {
            const groups = await sock.groupFetchAllParticipating();
            // Pastikan groups ada isinya sebelum di-keys
            groupIds = groups ? Object.keys(groups) : [];
        } catch (e) {
            return sock.sendMessage(m.chat, { text: '‚ùå Gagal mengambil daftar grup.' }, { quoted: m });
        }

        if (groupIds.length === 0) {
            return sock.sendMessage(m.chat, { text: '‚ùå Bot belum bergabung ke grup manapun.' }, { quoted: m });
        }

        await sock.sendMessage(m.chat, { text: `üì¢ Memulai Broadcast ke ${groupIds.length} grup...\n‚è≥ Jeda: 2 detik/grup` }, { quoted: m });

        // 4. Siapkan Buffer Media
        let mediaBuffer = null;
        let mediaType = null;

        if (isImage || isVideo) {
            const streamType = isImage ? 'image' : 'video';
            const messageContent = m.quoted ? m.quoted.msg : m.msg;
            try {
                mediaBuffer = await downloadMedia(messageContent, streamType);
                mediaType = streamType;
            } catch (e) {
                return sock.sendMessage(m.chat, { text: '‚ùå Gagal mendownload media.' }, { quoted: m });
            }
        }

        // 5. Loop & Kirim (SAFE MODE)
        let success = 0;
        let fail = 0;

        for (let id of groupIds) {
            // --- VALIDASI PENTING ---
            // Cek apakah ID valid dan merupakan grup (akhiran @g.us)
            if (!id || !id.endsWith('@g.us')) {
                continue; 
            }

            try {
                // Jeda (Anti Banned)
                await sleep(2000);

                if (mediaType === 'image') {
                    await sock.sendMessage(id, { 
                        image: mediaBuffer, 
                        caption: textToBroadcast,
                        contextInfo: { forwardingScore: 999, isForwarded: true } 
                    });
                } else if (mediaType === 'video') {
                    await sock.sendMessage(id, { 
                        video: mediaBuffer, 
                        caption: textToBroadcast,
                        contextInfo: { forwardingScore: 999, isForwarded: true } 
                    });
                } else {
                    await sock.sendMessage(id, { 
                        text: `üì¢ *BROADCAST*\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n${textToBroadcast}`,
                        contextInfo: { forwardingScore: 999, isForwarded: true }
                    });
                }

                success++;
            } catch (e) {
                // Tangkap error per grup agar bot TIDAK CRASH total
                // console.error(`Gagal kirim ke ${id}`);
                fail++;
            }
        }

        // 6. Laporan Selesai
        await sock.sendMessage(m.chat, { text: `‚úÖ *Broadcast Selesai*\n\nüü¢ Sukses: ${success}\nüî¥ Gagal: ${fail}` }, { quoted: m });
    }
};
